---
# PROVIDER-Validation-Process.yml
# This playbook validates provider data against various standards

- name: Provider Validation Process
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Get variables from previous job
    nppes_processed_count: "{{ hostvars.localhost.nppes_processed_count | default(1500000) }}"
    nppes_active_count: "{{ hostvars.localhost.nppes_active_count | default(1380000) }}"
    nppes_status: "{{ hostvars.localhost.nppes_status | default('completed') }}"
  
  tasks:
    - name: Check NPPES load status
      debug:
        msg: "Verifying NPPES load status: {{ nppes_status }} with {{ nppes_active_count }} active providers"
        
    - name: Set simulation variables
      set_fact:
        validation_batch_size: 10000
        total_batches: "{{ (nppes_active_count | int / 10000) | int }}"
        total_providers: "{{ nppes_active_count | int }}"
        output_directory: "/data/provider/validation/{{ '%Y%m%d' | strftime }}"
        
    - name: Create output directory
      debug:
        msg: "Creating directory {{ output_directory }}"
        
    - name: Initialize validation metrics
      set_fact:
        validated_providers: 0
        validation_errors: 0
        npi_validation_errors: 0
        address_validation_errors: 0
        taxonomy_validation_errors: 0
        license_validation_errors: 0
        high_risk_providers: 0
        
    - name: Connect to validation services
      debug:
        msg: "Connecting to validation services: NPI Registry, Address Validation, License Verification"
      register: services_connection
        
    - name: Process validation batches
      debug:
        msg: "Processing {{ total_batches }} validation batches ({{ validation_batch_size }} providers per batch)"
        
    - name: Run NPI registry validation
      debug:
        msg: "Validating provider NPIs against official CMS NPI registry"
        
    - name: Calculate NPI validation errors
      set_fact:
        npi_validation_errors: "{{ (total_providers | int * 0.008) | int }}"
        
    - name: Run address validation
      debug:
        msg: "Validating provider addresses against USPS database"
      set_fact:
        address_validation_errors: "{{ (total_providers | int * 0.025) | int }}"
        
    - name: Verify provider licenses
      debug:
        msg: "Verifying provider licenses against state licensing boards"
      set_fact:
        license_validation_errors: "{{ (total_providers | int * 0.012) | int }}"
        
    - name: Check for sanctions and exclusions
      debug:
        msg: "Checking providers against OIG exclusion list and NPDB"
      set_fact:
        high_risk_providers: "{{ (total_providers | int * 0.002) | int }}"
        
    - name: Validate taxonomy codes
      debug:
        msg: "Validating provider taxonomy codes against latest NUCC code set"
      set_fact:
        taxonomy_validation_errors: "{{ (total_providers | int * 0.015) | int }}"
        
    - name: Calculate total errors
      set_fact:
        validation_errors: "{{ (npi_validation_errors | int) + (address_validation_errors | int) + (license_validation_errors | int) + (taxonomy_validation_errors | int) }}"
        validated_providers: "{{ total_providers | int }}"
        
    - name: Create error reports
      debug:
        msg: "Creating detailed error reports for each validation type"
        
    - name: Flag high-risk providers
      debug:
        msg: "Flagging {{ high_risk_providers }} high-risk providers for review"
        
    - name: Generate validation summary
      debug:
        msg: |
          PROVIDER VALIDATION SUMMARY
          ===========================
          Total Providers Validated: {{ validated_providers }}
          Total Validation Errors: {{ validation_errors }} ({{ (validation_errors | int * 100 / validated_providers | int) | round(2) }}%)
          
          Error Breakdown:
          - NPI Validation Errors: {{ npi_validation_errors }} ({{ (npi_validation_errors | int * 100 / validated_providers | int) | round(2) }}%)
          - Address Validation Errors: {{ address_validation_errors }} ({{ (address_validation_errors | int * 100 / validated_providers | int) | round(2) }}%)
          - License Validation Errors: {{ license_validation_errors }} ({{ (license_validation_errors | int * 100 / validated_providers | int) | round(2) }}%)
          - Taxonomy Validation Errors: {{ taxonomy_validation_errors }} ({{ (taxonomy_validation_errors | int * 100 / validated_providers | int) | round(2) }}%)
          
          High-Risk Providers Identified: {{ high_risk_providers }}
          
          Validation completed in {{ (total_batches | int * 5) | int }} seconds
        
    - name: Update provider database flags
      debug:
        msg: "Updating validation flags in provider database for {{ validation_errors }} providers with issues"
        
    - name: Set output for workflow
      set_stats:
        data:
          provider_validated_count: "{{ validated_providers }}"
          provider_error_count: "{{ validation_errors }}"
          provider_high_risk_count: "{{ high_risk_providers }}"
          provider_validation_status: "completed"
        aggregate: yes
